# 要件定義書

## はじめに

コミュニティ型コンテンツプラットフォームは、Instagram の投稿性、Slack のカテゴリ性、Discord のリアクション性を融合した軽量コミュニティSNSプラットフォームです。ユーザーがテキストを投稿し、タグで整理されたチャンネルのような空間で交流できます。従来の「いいね」や数値的評価ではなく、感情ベースのリアクションで共感を表現することが特徴です。

## 用語集

- **Community_Platform**: コミュニティ型コンテンツプラットフォームシステム
- **User**: プラットフォームの利用者
- **Post**: ユーザーが投稿するコンテンツ（プレーンテキスト）
- **HashTag**: 投稿を分類するためのカテゴリラベル（例：#はじめて、#ペットの写真）
- **Reaction**: 投稿に対する感情ベースの反応（絵文字形式）
- **Channel**: タグによって分類された投稿の集合体
- **Feed**: 投稿の一覧表示画面
- **Profile**: ユーザーの個人情報と投稿履歴を表示するページ

## 要件

### 要件1

**ユーザーストーリー:** 新規ユーザーとして、アカウントを作成してプラットフォームにアクセスしたい。そうすることで、コミュニティに参加して投稿や交流ができるようになる。

#### 受け入れ基準

1. システムは、ユーザー登録機能を提供する
2. ユーザーがメールアドレスとパスワードを入力した時、システムはアカウントを作成する
3. システムは、OAuth認証（Google、GitHub等）をサポートするが、現在は必要ない。今後実装する予定。
4. ユーザーがログインした時、システムはセッション情報を管理する
5. システムは、ログアウト機能を提供する

### 要件2

**ユーザーストーリー:** 登録済みユーザーとして、テキストと画像を含む投稿を作成したい。そうすることで、自分の考えや体験をコミュニティと共有できる。

#### 受け入れ基準

1. ユーザーがログインしている時、システムは投稿作成機能を提供する
2. システムは、プレーンテキスト入力を受け付ける
3. システムは、投稿にハッシュタグを付与する機能を提供する
4. ユーザーが投稿を送信した時、システムは投稿をデータベースに保存する
5. システムは、画像アップロード機能を提供する

#### 画像投稿機能の詳細

**機能要件:**
1. システムは、投稿作成時に画像をアップロードする機能を提供する
2. システムは、1投稿あたり最大4枚までの画像アップロードをサポートする
3. システムは、画像のプレビュー表示機能を提供する
4. システムは、画像のドラッグ&ドロップアップロードをサポートする
5. システムは、JPEG、PNG、GIF、WebP形式の画像をサポートする
6. システムは、1枚あたり最大5MBまでの画像をサポートする
7. システムは、アップロード時に画像を自動的にリサイズ・最適化する（最大幅1200px）
8. システムは、投稿一覧および詳細ページで画像をグリッド表示する
9. システムは、画像クリック時にライトボックスで拡大表示する機能を提供する
10. システムは、画像の削除および差し替え機能を提供する
11. **（将来実装予定）** システムは、不適切な画像のレポート機能を提供する（モデレーション機能と連携）

**技術要件:**
1. 画像ストレージには Supabase Storage を使用する
2. 画像URLは`posts`テーブルの`image_urls`カラム（JSONB配列）に保存する
3. 画像のアップロードには、クライアントサイドからSupabase Storageへの直接アップロードを使用する
4. RLSポリシーにより、投稿者のみが自分の画像を削除できるように制限する
5. 画像ファイル名は一意性を保証するため、UUIDベースの命名規則を使用する（`{postId}/{timestamp}-{uuid}.{ext}`形式）

### 要件3

**ユーザーストーリー:** ユーザーとして、タグ別に整理された投稿を閲覧したい。そうすることで、興味のあるカテゴリのコンテンツを効率的に見つけることができる。

#### 受け入れ基準

1. システムは、固定のタグリストをサイドバーに表示する
2. ユーザーがタグをクリックした時、システムはそのハッシュタグの投稿一覧を表示する
3. システムは、投稿をタグごとにフィルタリングする機能を提供する
4. システムは、新着順で投稿を並び替える機能を提供する
5. システムは、未ログインユーザーにも投稿の閲覧を許可する

### 要件4

**ユーザーストーリー:** ログインユーザーとして、投稿に感情ベースのリアクションを付けたい。そうすることで、数値的評価ではなく多様な感情で共感を表現できる。また、自分の投稿にリアクションがついた時に通知を受け取りたい。

#### 受け入れ基準

1. ユーザーがログインしている時、システムは投稿にリアクション機能を提供する
2. システムは、絵文字ベースのリアクション（👏、💖、🤣の3種類）を提供する
3. システムは、1投稿につき1リアクションのみを許可する（排他的選択）
4. ユーザーが別のリアクションを選択した時、システムは既存のリアクションを自動的に削除し、新しいリアクションを追加する
5. ユーザーが同じリアクションを再度選択した時、システムはリアクションを削除する（トグル式）
6. ユーザーがリアクションを選択した時、システムはリアクションを即座に反映する
7. システムは、各リアクションの種類別カウントを表示する
8. **システムは、自分の投稿には自分でリアクションできないように制限する**
9. **システムは、自分の投稿でも他のユーザーがつけたリアクションは閲覧可能にする**
10. ユーザーの投稿に他のユーザーがリアクションした時、システムは投稿者に通知を送る
11. システムは、ヘッダーに通知アイコンと未読通知数のバッジを表示する
12. ユーザーが通知アイコンをクリックした時、システムは通知一覧をドロップダウンで表示する
13. システムは、通知を既読/未読で管理する
14. ユーザーが通知をクリックした時、システムは該当する投稿に遷移し、通知を既読にする

#### 自分の投稿へのリアクション制限

**ホーム画面・タグページ:**
- 自分の投稿のリアクションボタンは表示されるが、クリック不可（disabled）
- カーソルを合わせると禁止マーク（not-allowed）が表示される
- 他のユーザーがつけたリアクションは通常通り表示される（カウント付き）
- リアクション数が0の場合、ボタンは非表示

**プロフィールページ:**
- リアクションパネル自体が非表示
- 投稿内容と画像のみ表示される

#### 通知機能の詳細

**基本機能（Phase 1）:**
1. システムは、リアクション発生時に通知レコードをデータベースに作成する
2. システムは、通知一覧を作成日時の降順で表示する
3. システムは、通知テキストを「〇〇さんがあなたの投稿に👏しました」形式で生成する
4. システムは、通知をクリックした時に自動的に既読状態にする
5. システムは、未読通知数をヘッダーのベルアイコンにバッジ表示する

**将来実装予定（Phase 3 - リアルタイム通知）:**
1. システムは、Supabase Realtimeを使用してリアルタイム通知を配信する
2. システムは、ページリロードなしで新しい通知を即座に表示する
3. システムは、新しい通知受信時に視覚的なフィードバックを提供する

### 要件5

**ユーザーストーリー:** ユーザーとして、自分の投稿履歴とプロフィール情報を管理したい。そうすることで、個人のアイデンティティを表現し、過去の投稿を振り返ることができる。

#### 受け入れ基準

1. システムは、ユーザープロフィールページを提供する
2. システムは、デフォルトアバターを表示する
3. システムは、任意でプロフィール画像のアップロード機能を提供する
4. システムは、自己紹介文の編集機能を提供する
5. システムは、ユーザーの投稿履歴を時系列で表示する
6. システムは、表示名（display_name）が未設定の場合、ユーザー名（username）を代わりに表示する

### 要件6

**ユーザーストーリー:** ユーザーとして、投稿の編集と削除ができるようにしたい。そうすることで、自分のコンテンツを適切に管理できる。

#### 受け入れ基準

1. ユーザーが自分の投稿を表示している時、システムは編集・削除オプションを提供する
2. システムは、投稿内容の編集機能を提供する
3. システムは、投稿の削除機能を提供する
4. ユーザーが投稿を削除する時、システムは確認ダイアログを表示する
5. システムは、他のユーザーの投稿の編集・削除を禁止する

### 要件7

**ユーザーストーリー:** ユーザーとして、レスポンシブなUIでモバイルデバイスからもアクセスしたい。そうすることで、いつでもどこでもコミュニティに参加できる。

#### 受け入れ基準

1. システムは、モバイルデバイスに対応したレスポンシブデザインを提供する
2. システムは、タッチ操作に最適化されたUIを提供する
3. ユーザーがモバイルデバイスでアクセスした時、システムはサイドバーをハンバーガーメニューで表示する
4. システムは、画像の自動リサイズ機能を提供する
5. システムは、高速な読み込み速度を維持する

### 要件8

**ユーザーストーリー:** ユーザーとして、投稿に添付された画像を快適に閲覧したい。そうすることで、視覚的なコンテンツを楽しみ、より豊かなコミュニケーションができる。

#### 受け入れ基準

1. システムは、投稿一覧で画像のサムネイルを表示する
2. ユーザーが画像をクリックした時、システムは画像を拡大表示する
3. システムは、複数画像がある場合にギャラリー形式で表示する
4. ~~システムは、画像の遅延読み込み（Lazy Loading）を実装する~~
5. システムは、画像読み込み中にプレースホルダーを表示する
6. システムは、画像読み込みエラー時に代替表示を提供する
7. システムは、画像のalt属性を適切に設定してアクセシビリティを確保する